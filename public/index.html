<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Joytan Public</title>

  <!-- update the version number as needed -->
  <script defer src="/__/firebase/6.4.1/firebase-app.js"></script>
  <!-- include only the Firebase features as you need -->
  <script defer src="/__/firebase/6.4.1/firebase-auth.js"></script>
  <script defer src="/__/firebase/6.4.1/firebase-database.js"></script>
  <script defer src="/__/firebase/6.4.1/firebase-messaging.js"></script>
  <script defer src="/__/firebase/6.4.1/firebase-storage.js"></script>
  <!-- initialize the SDK after all desired features are loaded -->
  <script defer src="/__/firebase/init.js"></script>
  
  <!-- JQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <!-- For popup? -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>

  <!-- For accordion -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

  <!-- YouTube sub counter -->
  <script src="https://apis.google.com/js/platform.js"></script>

  <script src="/js/addPlayer.js"></script>
  <script src="/js/addProject.js"></script>
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/auth.css">
  <link rel="stylesheet" href="css/picker.css">
  <link rel="stylesheet" href="css/table.css">

  <link rel="apple-touch-icon" sizes="57x57" href="icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
  <link rel="manifest" href="icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <script type="text/javascript">
    window.onload = () => {
      const storage = firebase.storage();
      const storageRef = storage.ref();
      const topProjectsRef = storageRef.child('projects');
      const structureRef = storageRef.child('projects_structure.json');
      var structureData;

      structureRef.getDownloadURL().then(url => {
        $.getJSON(url, (data) => {
          loadProjects(data, topProjectsRef);
        })
      })
      // Close modal when clicking outside
      $("#auth-form").click(ev => {
        if(ev.target != document.getElementById("auth-form")) {
          return;
        } else {
          $("#auth-form").hide();
        }
      });
      $("#about-view").click(ev => {
        if(ev.target != document.getElementById("about-view")) {
          return;
        } else {
          $("#about-view").hide();
        }
      });

      firebase.auth().onAuthStateChanged(user => {
        if (user) {
          $("#auth-button").html(`Account <i class="fa fa-user" />`)
          $("#auth-button").show()
        } else {
          $("#auth-button").html("Log in &bull; Sign up")
          $("#auth-button").show()
        }
        // FIXME: Cannot move the show() outside of the if
      });

      document.getElementById('signup-form').onsubmit = e => {
        e.preventDefault();
      }
      document.getElementById('login-form').onsubmit = e => {
        e.preventDefault();
      }
      document.getElementById('learn-more').onclick = e => {
        e.preventDefault();
        console.log("learn more")
        $("#about-view").show();
      }

    } // ^^^^^ onload ^^^^^
    function loadProjects(structureJson, topRef) {
      topRef.listAll().then(res => {
        res.prefixes.forEach(projectRef => {
          addProject(structureJson[projectRef.name], projectRef);
        })
      })
    };

    function validatePassword(){
      var pswInput = document.getElementById("signup-psw");
      var confirmPswInput = document.getElementById("confirm-password");
      if(pswInput.value != confirmPswInput.value) {
        confirmPswInput.setCustomValidity("Passwords Don't Match");
        return false;
      } else {
        confirmPswInput.setCustomValidity('');
        return true;
      }
    }

    function createNewUser() {
      var emailInput = document.getElementById("signup-email");
      var pswInput = document.getElementById("signup-psw");
      var unameInput = document.getElementById("signup-uname");

      // MAYBE Need a fix because this is NOT called on actual submit.
      if (!emailInput.checkValidity() ||
          !pswInput.checkValidity() ||
          !unameInput.checkValidity() ||
          !validatePassword()) {
        return
      }

      //Create User with Email and Password
      firebase.auth().createUserWithEmailAndPassword(emailInput.value, pswInput.value).catch((error) => {
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        console.log(errorCode);
        console.log(errorMessage);
        throw error;
      }).then(userData => {
        console.log("Created new User! =>", userData)
        userData['user'].updateProfile({
          displayName: unameInput.value
        })
        closeAuthForm();
      });
    }
    function loginUser() {
      var password = $("#login-psw").val()
      var email = $("#login-email").val()
      //Sign In User with Email and Password
      firebase.auth().signInWithEmailAndPassword(email, password).catch((error) => {
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        console.log(errorCode);
        console.log(errorMessage);
        throw error;
      }).then(user => {
        console.log("Log in an user! =>", user)
        closeAuthForm();
      });
    }
    function signOutUser() {
      firebase.auth().signOut().then(function() {
        // Sign-out successful.
        console.log('User Logged Out!');
        closeAuthForm();
      }).catch(error => {
        // An error happened.
        console.log(error);
      });
    }
    function handleAuthButton() {
      var user = firebase.auth().currentUser;
      if (user) {
        generateAccountPage(user);
        document.getElementById("login-modal").style.display = "none"
        document.getElementById("signup-modal").style.display = "none"
        document.getElementById("account-modal").style.display = "block"
      } else {
        document.getElementById("login-modal").style.display = "none"
        document.getElementById("signup-modal").style.display = "block"
        document.getElementById("account-modal").style.display = "none"
      }
      document.getElementById("auth-form").style.display = "block";
    }
    function closeAuthForm() {
      $("#auth-form").hide();
      $("#about-view").hide();
    }

    function generateAccountPage(user) {
      var accountDiv = document.getElementById("account-modal");
      accountDiv.innerHTML = `
      <h2>Your Account</h2>
      <p>Thank you, ${user.displayName}, for your contribution!</p>
      <hr>
      <p>Your email address: ${user.email}</p>
      <p>Your total voice contribution: <span id="totalVoiceCount" style="font-size: 30px;"><b></b></span></p>
      <p>Your total votes: <span id="totalVoteCount" style="font-size: 30px;"><b></b></span></p>
      <p>Our project is still in an early stage. Your participation and contribution mean a lot to us üòåüèñÔ∏è.</p>

      <div class="clearfix">
        <center>
          <button class="btn btn-secondary" type="button" onclick="signOutUser()">Sign out</button>
        </center>
      </div>
      `
      firebase.database().ref("users").child(user.uid).child("audio").once('value').then(snapshot => {
        var totalVoteCount = 0
        if (snapshot.val()) {
          totalVoteCount = Object.keys(snapshot.val()).length
        }
        document.getElementById("totalVoiceCount").innerText = totalVoteCount.toString()
      })
      firebase.database().ref("users").child(user.uid).child("votes").once('value').then(snapshot => {
        var totalVoteCount = 0
        if (snapshot.val()) {
          totalVoteCount = Object.keys(snapshot.val()).length
        }
        document.getElementById("totalVoteCount").innerText = totalVoteCount.toString()
      })
    }
    // Smarter way to change login/signup modal
    function signupLoginTransition(nextModal) {
      if (nextModal == "login") {
        document.getElementById('signup-modal').style.display='none';
        document.getElementById('login-modal').style.display='block';
        // Copy draft email/psw to the next modal
        var draftEmail = document.getElementById('signup-email').value;
        var draftPsw = document.getElementById('signup-psw').value;
        document.getElementById('login-email').value = draftEmail;
        document.getElementById('login-psw').value = draftPsw;
      } else if (nextModal == "signup") {
        document.getElementById('login-modal').style.display='none';
        document.getElementById('signup-modal').style.display='block';
      }
    }
  </script>

</head>

<body>
  <div class="row justify-content-center">
    <div class="col-12">
      <div class="container">
        <h2 class="mt-2">Joytan Public 
          <img src="https://kokimame.github.io/joytan/images/joytan.png" width="28" height="28" style="margin-bottom: 5px;" alt="">
          <a class="fa fa-users" style="color: darkgreen; margin-left: 5px;"></a></h2>
          <p><b>Where we celebrate our special voice!</b> Please help us evaluate voice recordings for future language-teaching. 
          Your voice recordings sent through 
          <a href="https://play.google.com/store/apps/details?id=com.joytan.rec">Joytan-REC</a> (Android app)
           will immediately be available on this website! 
           <a href="" id="learn-more">Learn more</a>
        </p>

        <div class="g-ytsubscribe" data-channelid="UC0bLbtTI9uni3bNRPIJQAqA" data-layout="default" data-count="default"></div>
        <a href="https://play.google.com/store/apps/details?id=com.joytan.rec" class="fa icon fa-android"></a>
        <a href="https://github.com/kokimame/joytan" class="fa icon fa-github"></a>
        <a href="https://twitter.com/JoytanApp" class="fa icon fa-twitter"></a>

        <button id="auth-button" class="btn btn-info" onclick="handleAuthButton()" 
          style="display: none; float: right;"></button>

        <div id="about-view" class="modal">
          <span onclick="closeAuthForm()" class="close" title="Close Modal">&times;</span>
          <div class="modal-content">
            <div class="modal-container container">
              <div id="about-modal">
                <h2>About this website</h2>
                <hr>
                <p>
                  Joytan-REC aims to collect pronunciations (a single word to a short sentence)
                    from the crowd of language enthusiasts and make use of such voice recordings 
                    to develop free and fun language learning services. 
                </p>
                <p>
                  For instance, the voice recording you send through this app will be used in
                    our YouTube channel (Joytan App) and an even more open platform where everyone 
                    can freely download and use for educational purpose.
                </p>
                <p>
                For now, your benefits of contributing this project are a bumper ad/promo 
                (like your name, social account) or a short promotional movie at the beginning 
                of our YouTube video in which your voice recordings are used.
                  And of course, you will see more free and fun language learning videos from us 
                  because your contribution will grow our channel and attract other contributors.
                </p>
                <center>
                  <button class="btn btn-danger" type="button" onclick="closeAuthForm()" >Close</button>
                </center>
              </div>
            </div>
          </div>
        </div>

        <div id="auth-form" class="modal">
          <span onclick="closeAuthForm()" class="close" title="Close Modal">&times;</span>
          <div class="modal-content">
            <div class="modal-container container">
              <div id="signup-modal">
                <form id="signup-form" method="post">
                  <h2>Sign Up</h2>
                  <p>Have an account? <a href="#/" onclick="signupLoginTransition('login')"><b>Log in!</b></a></p>
                  <hr>
                  <p>Please fill in this form to create an account.</p>
                  <label for="signup-email"><b>Email</b></label>
                  <input id="signup-email" type="text" placeholder="Enter Email" name="signup-email"
                    pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" title="For example, [a-Z]@[a-Z].domain" required>
            
                  <label for="signup-psw"><b>Password</b></label>
                  <input id="signup-psw" type="password" placeholder="Enter Password" name="signup-psw" onchange="validatePassword()"
                    minlength="8" maxlength="15" required>
            
                  <label for="confirm-password"><b>Repeat Password</b></label>
                  <input id="confirm-password" type="password" placeholder="Repeat Password" name="psw-repeat" onkeyup="validatePassword()"
                   required>
    
                  <label for="signup-uname"><b>User name</b></label>
                  <input id="signup-uname" type="text" placeholder="Enter your Username" name="signup-uname"
                    minlength="3" maxlength="32" required>
                  
                  <label>
                    <input type="checkbox" checked="checked" name="remember" style="margin-bottom:15px"> Remember me
                  </label>
                        
                  <div class="clearfix">
                    <button class="modal-button cancel-btn" type="button" onclick="closeAuthForm()" >Cancel</button>
                    <button class="modal-button signup-btn btn-success" type="submit" onclick="createNewUser()">Sign Up</button>
                  </div>
                </form>
              </div>
              <div id="login-modal">
                <form id="login-form" method="post">
                  <h2>Log in</h2>
                  <p>Don't have an account? <a href="#/" onclick="signupLoginTransition('signup')"><b>Sign up!</b></a></p>
                  <hr>
                  <p>Please fill in this form to log in.</p>
                  <label for="email"><b>Email</b></label>
                  <input id="login-email" type="text" placeholder="Enter Email" name="email"
                    pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" title="For example, [a-Z]@[a-Z].domain" required>
            
                  <label for="psw"><b>Password</b></label>
                  <input id="login-psw" type="password" placeholder="Enter Password" name="psw" required
                    minlength="8" maxlength="15" required>
  
                  <label>
                    <input type="checkbox" checked="checked" name="remember" style="margin-bottom:15px"> Remember me
                  </label>
            
                  <div class="clearfix">
                    <button class="modal-button cancel-btn" type="button" onclick="closeAuthForm()" >Cancel</button>
                    <button class="modal-button login-btn btn-success" type="submit" onclick="loginUser()">Log in</button>
                  </div>
                </form>
              </div>
              <div id="account-modal">
              </div>
            </div>
          </div>
        </div>
        <hr />
        <div class="accordion" id="projectsTop">
        </div>
      </div>
    </div>


    <script>
      var firebaseConfig = {
        apiKey: "AIzaSyBr9SLxhKfyxzsbVmCVcn-J_QCgHQOqrOY",
        authDomain: "joytan-rec-16ba2.firebaseapp.com",
        databaseURL: "https://joytan-rec-16ba2.firebaseio.com",
        projectId: "joytan-rec-16ba2",
        storageBucket: "joytan-rec-16ba2.appspot.com",
        messagingSenderId: "950782104164",
        appId: "1:950782104164:web:adccd0fa64ae91ac"
      };
      firebase.initializeApp(firebaseConfig);
    </script>
</body>

</html>
